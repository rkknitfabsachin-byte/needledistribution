<!DOCTYPE html>
<html lang="hi">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>‡§∏‡•Å‡§à ‡§µ‡§ø‡§§‡§∞‡§£</title>

<style>
  body{
    margin:0;
    padding:16px;
    background:#f4f6f8;
    font-family: system-ui, -apple-system, BlinkMacSystemFont;
  }
  h2{margin:0 0 12px}
  h3{margin:0 0 8px}
  .card{
    background:#fff;
    border-radius:14px;
    padding:14px;
    margin-bottom:14px;
  }
  label{
    font-size:14px;
    color:#444;
  }
  select,input,button{
    width:100%;
    padding:10px;
    margin-top:8px;
    font-size:16px;
    border-radius:10px;
    border:1px solid #ddd;
  }
  button{
    background:#111;
    color:#fff;
    border:none;
    font-weight:600;
  }
  .row{
    display:flex;
    gap:8px;
    margin-top:8px;
  }
  .row input:first-child{
    background:#f0f0f0;
  }
  .row > *{
    flex:1;
  }
</style>
</head>

<body>

<h2>ü™° ‡§∏‡•Å‡§à ‡§µ‡§ø‡§§‡§∞‡§£</h2>

<div class="card">
  <label>‡§Æ‡§∂‡•Ä‡§® ‡§ö‡•Å‡§®‡•á‡§Ç</label>
  <select id="machine" onchange="loadNeedles()">
    <option value="">-- ‡§Æ‡§∂‡•Ä‡§® ‡§ö‡•Å‡§®‡•á‡§Ç --</option>
  </select>
</div>

<div class="card">
  <h3>‡§°‡§æ‡§Ø‡§≤ ‡§∏‡•Å‡§à</h3>
  <div id="dial">‡§Æ‡§∂‡•Ä‡§® ‡§ö‡•Å‡§®‡•á‡§Ç</div>
</div>

<div class="card">
  <h3>‡§∏‡§ø‡§≤‡•á‡§Ç‡§°‡§∞ ‡§∏‡•Å‡§à</h3>
  <div id="cylinder">‡§Æ‡§∂‡•Ä‡§® ‡§ö‡•Å‡§®‡•á‡§Ç</div>
</div>

<button onclick="saveAll()">‡§∏‡•á‡§µ ‡§ï‡§∞‡•á‡§Ç</button>

<script>
/* üî• CLOUDFLARE WORKER API */
const API = "https://needle-mountain-76a5.rkknitfabsachin.workers.dev";

let entries = [];

/* ========= LOAD MACHINES ========= */
async function loadMachines(){
  try{
    const res = await fetch(API + "?action=machines");
    const machines = await res.json();

    const sel = document.getElementById("machine");
    sel.innerHTML = '<option value="">-- ‡§Æ‡§∂‡•Ä‡§® ‡§ö‡•Å‡§®‡•á‡§Ç --</option>';
    machines.forEach(m=>{
      sel.innerHTML += `<option value="${m}">${m}</option>`;
    });
  }catch(e){
    alert("‡§Æ‡§∂‡•Ä‡§® ‡§≤‡•ã‡§° ‡§®‡§π‡•Ä‡§Ç ‡§π‡•Å‡§à");
    console.error(e);
  }
}

/* ========= LOAD NEEDLES ========= */
async function loadNeedles(){
  const m = machine.value;
  document.getElementById("dial").innerHTML = '';
  document.getElementById("cylinder").innerHTML = '';
  entries = [];

  if(!m){
    dial.innerHTML = cylinder.innerHTML = '‡§Æ‡§∂‡•Ä‡§® ‡§ö‡•Å‡§®‡•á‡§Ç';
    return;
  }

  try{
    const res = await fetch(API + "?action=needles&machine=" + m);
    const data = await res.json();

    renderNeedles(data.dial, "dial", "Dial");
    renderNeedles(data.cylinder, "cylinder", "Cylinder");
  }catch(e){
    alert("‡§∏‡•Å‡§à ‡§≤‡•ã‡§° ‡§®‡§π‡•Ä‡§Ç ‡§π‡•Å‡§à");
    console.error(e);
  }
}

/* ========= RENDER ========= */
function renderNeedles(list, containerId, section){
  const box = document.getElementById(containerId);

  if(list.length === 0){
    box.innerHTML = "<small>‡§ï‡•ã‡§à ‡§∏‡•Å‡§à ‡§®‡§π‡•Ä‡§Ç</small>";
    return;
  }

  box.innerHTML = list.map(n => `
    <div class="row">
      <input value="${n}" disabled>
      <input type="number" min="0" placeholder="‡§ï‡§ø‡§§‡§®‡•Ä ‡§∏‡•Å‡§à"
        onchange="addEntry('${section}','${n}',this.value)">
    </div>
  `).join('');
}

/* ========= COLLECT ENTRY ========= */
function addEntry(section, needle, qty){
  if(!qty || qty <= 0) return;

  entries = entries.filter(e => !(e.section === section && e.needle === needle));

  entries.push({
    machine: machine.value,
    section,
    needle,
    qty: Number(qty)
  });
}

/* ========= SAVE ========= */
async function saveAll(){
  if(entries.length === 0){
    alert("‡§ï‡•ã‡§à ‡§è‡§Ç‡§ü‡•ç‡§∞‡•Ä ‡§®‡§π‡•Ä‡§Ç ‡§π‡•à");
    return;
  }

  try{
    await fetch(API,{
      method:"POST",
      body:JSON.stringify({
        action:"save",
        entries: entries
      })
    });

    alert("‡§°‡•á‡§ü‡§æ ‡§∏‡•á‡§µ ‡§π‡•ã ‡§ó‡§Ø‡§æ");
    loadNeedles();
  }catch(e){
    alert("‡§∏‡•á‡§µ ‡§®‡§π‡•Ä‡§Ç ‡§π‡•Å‡§Ü");
    console.error(e);
  }
}

loadMachines();
</script>

</body>
</html>
