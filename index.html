<!DOCTYPE html>
<html lang="hi">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>‡§∏‡•Å‡§à ‡§µ‡§ø‡§§‡§∞‡§£</title>
<style>
body{font-family:system-ui;background:#f4f6f8;margin:0;padding:16px}
.card{background:#fff;border-radius:14px;padding:14px;margin-bottom:14px}
select,input,button{width:100%;padding:10px;margin-top:8px;font-size:16px}
button{background:#111;color:#fff;border:none;border-radius:10px}
.row{display:flex;gap:8px}
.row>*{flex:1}
</style>
</head>
<body>

<h2>ü™° ‡§∏‡•Å‡§à ‡§µ‡§ø‡§§‡§∞‡§£</h2>

<div class="card">
  <label>‡§Æ‡§∂‡•Ä‡§® ‡§ö‡•Å‡§®‡•á‡§Ç</label>
  <select id="machine" onchange="loadNeedles()">
    <option value="">-- ‡§ö‡•Å‡§®‡•á‡§Ç --</option>
  </select>
</div>

<div class="card">
  <h3>‡§°‡§æ‡§Ø‡§≤ ‡§∏‡•Å‡§à</h3>
  <div id="dial">‡§Æ‡§∂‡•Ä‡§® ‡§ö‡•Å‡§®‡•á‡§Ç</div>
</div>

<div class="card">
  <h3>‡§∏‡§ø‡§≤‡•á‡§Ç‡§°‡§∞ ‡§∏‡•Å‡§à</h3>
  <div id="cylinder">‡§Æ‡§∂‡•Ä‡§® ‡§ö‡•Å‡§®‡•á‡§Ç</div>
</div>

<button onclick="saveAll()">‡§∏‡•á‡§µ ‡§ï‡§∞‡•á‡§Ç</button>

<script>
const API = "https://needle-mountain-76a5.rkknitfabsachin.workers.dev";
let entries = [];

async function loadMachines(){
  const res = await fetch(API + "?action=machines");
  const data = JSON.parse(await res.text());

  if (!Array.isArray(data)) {
    alert("Server error");
    console.error(data);
    return;
  }

  machine.innerHTML = '<option value="">-- ‡§ö‡•Å‡§®‡•á‡§Ç --</option>';
  data.forEach(m => {
    machine.innerHTML += `<option value="${m}">${m}</option>`;
  });
}

async function loadNeedles(){
  dial.innerHTML = cylinder.innerHTML = '';
  entries = [];

  if(!machine.value){
    dial.innerHTML = cylinder.innerHTML = '‡§Æ‡§∂‡•Ä‡§® ‡§ö‡•Å‡§®‡•á‡§Ç';
    return;
  }

  const res = await fetch(API + "?action=needles&machine=" + machine.value);
  const data = JSON.parse(await res.text());

  if (!data || !Array.isArray(data.dial) || !Array.isArray(data.cylinder)) {
    alert("Server error");
    console.error(data);
    return;
  }

  render(data.dial, 'dial', 'Dial');
  render(data.cylinder, 'cylinder', 'Cylinder');
}

function render(list, id, section){
  const box = document.getElementById(id);
  if(list.length === 0){
    box.innerHTML = '‡§ï‡•ã‡§à ‡§∏‡•Å‡§à ‡§®‡§π‡•Ä‡§Ç';
    return;
  }

  box.innerHTML = list.map(n => `
    <div class="row">
      <input value="${n}" disabled>
      <input type="number" min="0" placeholder="Qty"
        onchange="addEntry('${section}','${n}',this.value)">
    </div>
  `).join('');
}

function addEntry(section, needle, qty){
  if(!qty || qty <= 0) return;
  entries = entries.filter(e => !(e.section===section && e.needle===needle));
  entries.push({ machine: machine.value, section, needle, qty: Number(qty) });
}

async function saveAll(){
  if(entries.length === 0){
    alert("‡§ï‡•ã‡§à ‡§è‡§Ç‡§ü‡•ç‡§∞‡•Ä ‡§®‡§π‡•Ä‡§Ç");
    return;
  }

  await fetch(API, {
    method: "POST",
    body: JSON.stringify({ action:"save", entries })
  });

  alert("‡§∏‡•á‡§µ ‡§π‡•ã ‡§ó‡§Ø‡§æ");
  loadNeedles();
}

loadMachines();
</script>
</body>
</html>
