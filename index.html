<!DOCTYPE html>
<html lang="hi">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>Needle Distribution</title>

<style>
body{font-family:system-ui;background:#f4f6f8;margin:0;padding:16px}
.card{background:#fff;border-radius:14px;padding:16px;margin-bottom:14px}
h2{margin:0 0 10px}
select,input,button{width:100%;padding:10px;margin-top:8px;font-size:16px}
button{background:#111;color:#fff;border:none;border-radius:10px}
.row{display:flex;gap:8px}
.row>*{flex:1}
.small{font-size:14px;color:#555}
</style>
</head>

<body>

<h2>ü™° ‡§∏‡•Å‡§à ‡§µ‡§ø‡§§‡§∞‡§£</h2>

<div class="card">
  <label>‡§Æ‡§∂‡•Ä‡§® ‡§ö‡•Å‡§®‡•á‡§Ç</label>
  <select id="machine" onchange="loadNeedles()"></select>
</div>

<div class="card">
  <h3>‡§°‡§æ‡§Ø‡§≤ ‡§∏‡•Å‡§à</h3>
  <div id="dial"></div>
</div>

<div class="card">
  <h3>‡§∏‡§ø‡§≤‡•á‡§Ç‡§°‡§∞ ‡§∏‡•Å‡§à</h3>
  <div id="cylinder"></div>
</div>

<button onclick="saveAll()">‡§∏‡•á‡§µ ‡§ï‡§∞‡•á‡§Ç</button>

<script>
const API = "https://script.google.com/macros/s/AKfycbzK_Yu21KjP9q25TjnQbNzqshO-tm_wOcxDoPID9z5KznXadoI_SA67IsM_4ot09Ebq5Q/exec";
let entries = [];

async function loadMachines(){
  const r = await fetch(API+'?action=machines');
  const m = await r.json();
  machine.innerHTML = '<option value="">-- ‡§ö‡•Å‡§®‡•á‡§Ç --</option>' +
    m.map(x=>`<option>${x}</option>`).join('');
}

async function loadNeedles(){
  dial.innerHTML = cylinder.innerHTML = '';
  entries = [];

  const m = machine.value;
  if(!m) return;

  const r = await fetch(API+`?action=needles&machine=${m}`);
  const d = await r.json();

  render(d.dial,'dial','Dial');
  render(d.cylinder,'cylinder','Cylinder');
}

function render(list,el,section){
  document.getElementById(el).innerHTML = list.map(n=>`
    <div class="row">
      <input value="${n}" disabled>
      <input type="number" min="0" placeholder="Qty"
        onchange="addEntry('${section}','${n}',this.value)">
    </div>
  `).join('');
}

function addEntry(section,needle,qty){
  if(!qty) return;
  entries = entries.filter(e=>!(e.section===section && e.needle===needle));
  entries.push({
    machine: machine.value,
    section, needle,
    qty: Number(qty)
  });
}

async function saveAll(){
  if(entries.length===0){alert('‡§ï‡•ã‡§à ‡§è‡§Ç‡§ü‡•ç‡§∞‡•Ä ‡§®‡§π‡•Ä‡§Ç');return;}

  await fetch(API,{
    method:'POST',
    body:JSON.stringify({action:'save',entries})
  });

  alert('‡§∏‡•á‡§µ ‡§π‡•ã ‡§ó‡§Ø‡§æ');
  loadNeedles();
}

loadMachines();
</script>

</body>
</html>
